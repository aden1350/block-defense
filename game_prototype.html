<!DOCTYPE html>
<html>
<head>
    <title>方块塔防 - Block Defense</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        body {
            margin: 0;
            background: #0a0a1a;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: 'Courier New', monospace;
            overflow: hidden;
        }
        #gameCanvas {
            border: 2px solid #333;
            box-shadow: 0 0 40px rgba(0,200,255,0.15);
        }
        #ui {
            position: absolute;
            top: 20px;
            left: 20px;
            color: #0ff;
            font-size: 16px;
            text-shadow: 0 0 10px #0ff;
        }
        #instructions {
            position: absolute;
            bottom: 20px;
            color: #666;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div id="ui">
        <div>分数: <span id="score">0</span></div>
        <div>波次: <span id="wave">1</span></div>
        <div>生命: <span id="lives">100</span></div>
    </div>
    <canvas id="gameCanvas"></canvas>
    <div id="instructions">← → 移动 | ↑ 旋转 | ↓ 加速 | 空格 放置</div>

    <script>
        // Matter.js 模块
        const { Engine, Render, Runner, Bodies, Body, Composite, Events, Vector } = Matter;

        // 创建引擎
        const engine = Engine.create();
        const world = engine.world;

        // 画布大小
        const width = 800;
        const height = 600;
        const canvas = document.getElementById('gameCanvas');
        canvas.width = width;
        canvas.height = height;

        // 创建渲染器
        const render = Render.create({
            canvas: canvas,
            engine: engine,
            options: {
                width: width,
                height: height,
                wireframes: false,
                background: '#0a0a1a'
            }
        });

        // 游戏状态
        let score = 0;
        let wave = 1;
        let lives = 100;
        let currentBlock = null;
        let placedBlocks = [];
        let enemies = [];
        let projectiles = [];

        // 平台位置
        const platformX = 300;
        const platformY = 480;
        const platformWidth = 200;
        const platformHeight = 15;

        // 创建平台（静态物体）
        const platform = Bodies.rectangle(
            platformX + platformWidth/2,
            platformY,
            platformWidth,
            platformHeight,
            { isStatic: true, render: { fillStyle: '#334' } }
        );
        Composite.add(world, platform);

        // 底部检测（掉出后删除）
        const deathZone = Bodies.rectangle(width/2, height + 50, width * 2, 50, { isStatic: true, isSensor: true });
        Composite.add(world, deathZone);

        // 俄罗斯方块形状定义
        const SHAPES = [
            // I型 (1x4)
            { color: '#0ff', blocks: [{x:0,y:0}, {x:1,y:0}, {x:2,y:0}, {x:3,y:0}] },
            // O型 (2x2)
            { color: '#ff0', blocks: [{x:0,y:0}, {x:1,y:0}, {x:0,y:1}, {x:1,y:1}] },
            // T型
            { color: '#a0f', blocks: [{x:0,y:0}, {x:1,y:0}, {x:2,y:0}, {x:1,y:1}] },
            // L型
            { color: '#f80', blocks: [{x:0,y:0}, {x:0,y:1}, {x:0,y:2}, {x:1,y:2}] },
            // J型
            { color: '#08f', blocks: [{x:1,y:0}, {x:1,y:1}, {x:1,y:2}, {x:0,y:2}] },
            // S型
            { color: '#0f0', blocks: [{x:1,y:0}, {x:2,y:0}, {x:0,y:1}, {x:1,y:1}] },
            // Z型
            { color: '#f00', blocks: [{x:0,y:0}, {x:1,y:0}, {x:1,y:1}, {x:2,y:1}] }
        ];

        // 塔的属性
        const TOWER_PROPS = {
            '#0ff': { name: '冰塔', damage: 5, range: 150, slow: 0.5 },
            '#ff0': { name: '炮塔', damage: 20, range: 100, attackSpeed: 500 },
            '#a0f': { name: '电塔', damage: 10, range: 120, chain: 3 },
            '#f80': { name: '箭塔', damage: 8, range: 180, attackSpeed: 300 },
            '#08f': { name: '毒塔', damage: 3, range: 100, poison: 2 },
            '#0f0': { name: '火塔', damage: 15, range: 90, attackSpeed: 800 },
            '#f00': { name: '核塔', damage: 30, range: 80 }
        };

        // 怪物定义
        const ENEMIES = [
            { color: '#f55', hp: 20, speed: 1.5, reward: 5 },
            { color: '#ff5', hp: 40, speed: 1, reward: 10 },
            { color: '#55f', hp: 80, speed: 0.7, reward: 20 },
            { color: '#f0f', hp: 150, speed: 0.4, reward: 50 }
        ];

        const blockSize = 20;

        // 创建当前下落的方块
        function createBlock() {
            const shape = SHAPES[Math.floor(Math.random() * SHAPES.length)];
            const bodies = [];
            
            // 创建方块的每个部分
            for (let b of shape.blocks) {
                const part = Bodies.rectangle(
                    400 + b.x * blockSize,
                    50 + b.y * blockSize,
                    blockSize - 2,
                    blockSize - 2,
                    {
                        render: { fillStyle: shape.color },
                        friction: 0.8,
                        frictionStatic: 1,
                        restitution: 0.1
                    }
                );
                bodies.push(part);
            }

            // 用约束连接
            currentBlock = {
                bodies: bodies,
                color: shape.color,
                props: TOWER_PROPS[shape.color] || { name: '塔', damage: 10, range: 100 },
                isFalling: true,
                canControl: true
            };

            for (let body of bodies) {
                body.blockData = currentBlock;
            }
            Composite.add(world, bodies);
        }

        // 旋转方块
        function rotateBlock() {
            if (!currentBlock || !currentBlock.canControl) return;
            
            const center = currentBlock.bodies[0].position;
            for (let body of currentBlock.bodies) {
                const dx = body.position.x - center.x;
                const dy = body.position.y - center.y;
                const angle = Math.PI / 2;
                const newX = center.x - dy;
                const newY = center.y + dx;
                Body.setPosition(body, { x: newX, y: newY });
            }
        }

        // 移动方块
        function moveBlock(dx) {
            if (!currentBlock || !currentBlock.canControl) return;
            for (let body of currentBlock.bodies) {
                Body.setPosition(body, {
                    x: body.position.x + dx,
                    y: body.position.y
                });
                // 边界检查
                if (body.position.x < 0) {
                    Body.setPosition(body, { x: blockSize, y: body.position.y });
                }
                if (body.position.x > width) {
                    Body.setPosition(body, { x: width - blockSize, y: body.position.y });
                }
            }
        }

        // 放置方块
        function placeBlock() {
            if (!currentBlock || !currentBlock.canControl) return;
            
            currentBlock.canControl = false;
            currentBlock.isFalling = false;
            placedBlocks.push(currentBlock);
            currentBlock = null;
            
            // 1秒后生成新方块
            setTimeout(createBlock, 1000);
        }

        // 快速下落
        function dropBlock() {
            if (!currentBlock || !currentBlock.canControl) return;
            for (let body of currentBlock.bodies) {
                Body.setVelocity(body, { x: 0, y: 10 });
            }
        }

        // 射击
        function shoot(block) {
            const props = block.props;
            
            // 找最近的敌人
            let nearest = null;
            let minDist = props.range;
            
            for (let enemy of enemies) {
                const center = block.bodies[0].position;
                const dx = enemy.body.position.x - center.x;
                const dy = enemy.body.position.y - center.y;
                const dist = Math.sqrt(dx*dx + dy*dy);
                if (dist < minDist) {
                    minDist = dist;
                    nearest = enemy;
                }
            }
            
            if (nearest) {
                const center = block.bodies[0].position;
                const bullet = Bodies.circle(center.x, center.y, 4, {
                    render: { fillStyle: block.color },
                    label: 'bullet',
                    bulletData: { target: nearest, damage: props.damage, color: block.color }
                });
                Composite.add(world, bullet);
                projectiles.push(bullet);
            }
        }

        // 生成敌人
        function spawnEnemy() {
            const type = ENEMIES[Math.floor(Math.random() * ENEMIES.length)];
            const fromLeft = Math.random() > 0.5;
            
            const enemyBody = Bodies.circle(
                fromLeft ? -20 : width + 20,
                platformY - 30,
                12,
                {
                    render: { fillStyle: type.color },
                    friction: 0,
                    frictionAir: 0
                }
            );
            
            const enemy = {
                body: enemyBody,
                type: type,
                hp: type.hp,
                maxHp: type.hp
            };
            
            enemies.push(enemy);
            Composite.add(world, enemyBody);
        }

        // 检测方块掉落
        Events.on(engine, 'collisionStart', (event) => {
            for (let pair of event.pairs) {
                if (pair.bodyA === deathZone || pair.bodyB === deathZone) {
                    const other = pair.bodyA === deathZone ? pair.bodyB : pair.bodyA;
                    if (other.blockData) {
                        // 方块掉出平台
                        Composite.remove(world, other);
                        // 从数组中移除
                        const idx = placedBlocks.indexOf(other.blockData);
                        if (idx > -1) placedBlocks.splice(idx, 1);
                    }
                }
            }
        });

        // 游戏更新
        Events.on(engine, 'beforeUpdate', () => {
            // 更新子弹
            for (let i = projectiles.length - 1; i >= 0; i--) {
                const bullet = projectiles[i];
                const target = bullet.bulletData.target;
                
                if (!enemies.includes(target)) {
                    Composite.remove(world, bullet);
                    projectiles.splice(i, 1);
                    continue;
                }
                
                const dx = target.body.position.x - bullet.position.x;
                const dy = target.body.position.y - bullet.position.y;
                const dist = Math.sqrt(dx*dx + dy*dy);
                
                if (dist < 15) {
                    // 命中
                    target.hp -= bullet.bulletData.damage;
                    Composite.remove(world, bullet);
                    projectiles.splice(i, 1);
                    
                    if (target.hp <= 0) {
                        score += target.type.reward;
                        Composite.remove(world, target.body);
                        const idx = enemies.indexOf(target);
                        if (idx > -1) enemies.splice(idx, 1);
                    }
                } else {
                    Body.setVelocity(bullet, {
                        x: (dx/dist) * 8,
                        y: (dy/dist) * 8
                    });
                }
            }
            
            // 敌人移动
            for (let enemy of enemies) {
                const targetX = platformX + platformWidth/2;
                const dx = targetX - enemy.body.position.x;
                
                if (Math.abs(dx) > 10) {
                    Body.setVelocity(enemy.body, {
                        x: Math.sign(dx) * enemy.type.speed,
                        y: 0
                    });
                } else {
                    // 到达平台，扣血
                    lives -= 0.1;
                    if (lives <= 0) lives = 0;
                }
            }
            
            // 塔自动射击
            for (let block of placedBlocks) {
                if (Math.random() < 0.02) {
                    shoot(block);
                }
            }
            
            // 更新UI
            document.getElementById('score').textContent = score;
            document.getElementById('wave').textContent = wave;
            document.getElementById('lives').textContent = Math.floor(lives);
            
            // 生成敌人
            if (enemies.length === 0 && Math.random() < 0.01) {
                wave++;
                for (let i = 0; i < wave * 2; i++) {
                    setTimeout(spawnEnemy, i * 1500);
                }
            }
        });

        // 键盘控制
        document.addEventListener('keydown', (e) => {
            switch(e.key) {
                case 'ArrowLeft':
                    moveBlock(-20);
                    break;
                case 'ArrowRight':
                    moveBlock(20);
                    break;
                case 'ArrowUp':
                    rotateBlock();
                    break;
                case 'ArrowDown':
                    dropBlock();
                    break;
                case ' ':
                    placeBlock();
                    break;
            }
        });

        // 启动
        createBlock();
        Render.run(render);
        const runner = Runner.create();
        Runner.run(runner, engine);

        // 初始敌人
        setTimeout(spawnEnemy, 2000);
        setTimeout(spawnEnemy, 4000);
    </script>
</body>
</html>
